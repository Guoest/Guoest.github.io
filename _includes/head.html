<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% if page.robots %}
  <meta name="robots" content="{{ page.robots }}">
  {% endif %}
  {%- seo -%}

  <!-- Enhanced meta descriptions -->
  {% if page.description %}
  <meta name="description" content="{{ page.description }}">
  {% elsif page.excerpt %}
  <meta name="description" content="{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}">
  {% else %}
  <meta name="description" content="{{ site.description }}">
  {% endif %}

  <!-- Open Graph metadata for social sharing -->
  <meta property="og:site_name" content="{{ site.title }}">
  <meta property="og:type" content="{% if page.layout == 'post' %}article{% else %}website{% endif %}">
  <meta property="og:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
  <meta property="og:description" content="{% if page.description %}{{ page.description }}{% elsif page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  <meta property="og:url" content="{{ site.url }}{{ page.url }}">
  {% if page.image %}
  <meta property="og:image" content="{{ site.url }}{{ page.image }}">
  {% elsif page.thumbnail %}
  <meta property="og:image" content="{{ site.url }}{{ page.thumbnail }}">
  {% endif %}

  <!-- Twitter Card metadata -->
  <meta name="twitter:card" content="summary_large_image">
  {% if site.twitter_username %}
  <meta name="twitter:site" content="@{{ site.twitter_username }}">
  <meta name="twitter:creator" content="@{{ site.twitter_username }}">
  {% endif %}
  <meta name="twitter:title" content="{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}">
  <meta name="twitter:description" content="{% if page.description %}{{ page.description }}{% elsif page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">
  {% if page.image %}
  <meta name="twitter:image" content="{{ site.url }}{{ page.image }}">
  {% elsif page.thumbnail %}
  <meta name="twitter:image" content="{{ site.url }}{{ page.thumbnail }}">
  {% endif %}
  <link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ "/assets/main.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/categories.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/thumbnails.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/post-images.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/darkmode-text.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/header.css" | relative_url }}">
  <link rel="stylesheet" href="{{ "/assets/css/giscus-custom.css" | relative_url }}">
  {%- feed_meta -%}
  <!-- Dark mode toggle script -->
  <script src="{{ "/assets/js/darkmode.js" | relative_url }}" defer></script>
  <!-- Google tag (gtag.js) -->
  {% if site.google_analytics %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '{{ site.google_analytics }}');
  </script>
  {% endif %}

  {% if site.use_math %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
          ]}
        );
      });
    </script>
  {% endif %}

  <script>
  function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
  }
  window.onload = wrap_img;
  </script>

  <!-- Language detection and switching -->
  <script src="{{ "/assets/js/language.js" | relative_url }}" defer></script>

  <!-- Language alternates for SEO -->
  {% assign current_path = page.url | remove_first: '/zh' %}
  <link rel="alternate" hreflang="en" href="{{ site.url }}{{ current_path }}" />
  <link rel="alternate" hreflang="zh-Hans" href="{{ site.url }}/zh{{ current_path }}" />
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ current_path }}" />

</head>
